<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Halloween Treat Tracker</title>
  <style>
    :root {
      --bg: #0b0620;
      --bg2: #120a2a;
      --fg: #f5f3ff;
      --accent: #ff6a00; /* pumpkin orange */
      --accent2: #14ff72; /* slime green */
      --muted: #9aa3b2;
      --card: #1a123a;
      --overlay: rgba(0,0,0,.5);
    }
    html, body { height: 100%; margin: 0; }
    body {
      background: radial-gradient(1200px 800px at 70% -10%, #1a0f34 0, #0b0620 60%);
      color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-tap-highlight-color: transparent;
    }
    .app { position: relative; height: 100dvh; display: flex; flex-direction: column; }

    .header {
      position: absolute; top: 0; left: 0; right: 0;
      display: flex; justify-content: space-between; align-items: center;
      padding: calc(0.8em + env(safe-area-inset-top)) calc(1.4em + env(safe-area-inset-right)) 0.8em calc(1.4em + env(safe-area-inset-left));
      z-index: 10;
    }
    .header .btn {
      background: rgba(255,255,255,0.08); border: 0.08em solid rgba(255,255,255,0.15);
      color: var(--fg); padding: 0.9em 1.1em; border-radius: 1.4em; backdrop-filter: blur(0.5em); -webkit-backdrop-filter: blur(0.5em);
      font-weight: 700; user-select: none; touch-action: manipulation; margin: 0 0.6em; font-size: 1.05em;
    }
    .header .btn:active { transform: scale(0.98); }
    .header .btn.hold { position: relative; overflow: hidden; }
    .hold-progress { position: absolute; inset: 0; background: var(--accent); opacity: 0.15; transform: scaleX(0); transform-origin: left; transition: transform .1s linear; }
    .title { font-weight: 800; letter-spacing: .035em; font-size: 1.1em; }

    .main { flex: 1; display: grid; grid-template-rows: 1fr 1fr; gap: 0.8em; padding: calc(5.3em + env(safe-area-inset-top)) 1.2em 1.2em; }
    .pane { border-radius: 1.1em; background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); outline: 0.08em solid rgba(255,255,255,0.1); box-shadow: 0 1.2em 2.4em rgba(0,0,0,0.25) inset; position: relative; overflow: hidden; min-height: 0; }

    /* Tap flash feedback */
    @keyframes paneFlash { from { background-color: rgba(255,106,0,.25); } to { background-color: transparent; } }
    .pane.flash { animation: paneFlash 180ms ease; }

    /* TAP MODE */
    .inputPane, .enterPane { display:flex; place-items:center; justify-content:center; text-align:center; padding: 1em; min-height: 0; }
    .topStatus { font-size: clamp(1.8em,7vw,2.8em); font-weight: 800; letter-spacing: .03em; text-shadow: 0 0.12em 0.5em rgba(0,0,0,.4); }

    .enterInner { display:flex; flex-direction:column; gap: 0.8em; align-items:center; justify-content:center; width: 100%; }
    .line { font-size: clamp(1.4em,7vw,2.2em); font-weight: 800; letter-spacing: .03em; }
    .subtle { font-weight: 600; color: var(--muted); font-size: clamp(0.85em,3.5vw,0.95em); }

    .spooky { position:absolute; bottom: 0.8em; right: 0.8em; font-size: 1.25em; }

    .toast { position: fixed; left: 50%; bottom: calc(1.2em + env(safe-area-inset-bottom)); transform: translateX(-50%); background: rgba(0,0,0,.8); color: #fff; padding: 0.7em 0.9em; border-radius: 0.9em; font-size: 0.9em; opacity:0; pointer-events:none; transition: opacity .2s, transform .2s; z-index: 200; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(-0.25em); }

    .sidebar { position: fixed; top: 0; right: 0; width: min(90vw, 24em); height: 100dvh; background: #0e0826; box-shadow: -0.9em 0 2em rgba(0,0,0,.5); border-left: 0.06em solid rgba(255,255,255,.07); transform: translateX(100%); transition: transform .25s ease; z-index: 150; display:flex; flex-direction: column; }
    .sidebar.open { transform: translateX(0%); }
    .sidebar .grab { width: 2.2em; height: 0.25em; border-radius: 0.25em; background: rgba(255,255,255,.28); align-self:center; margin: 0.8em 0; }
    .sidebar header { display:flex; align-items:center; justify-content: space-between; padding: 0.8em 0.9em; border-bottom: 0.06em solid rgba(255,255,255,.08);} 
    .sidebar header .full { background: var(--accent); color:#000; font-weight:700; padding:0.6em 0.7em; border-radius:0.7em; }
    .sidebar .list { overflow: auto; padding: 0.7em 0.9em; display:flex; flex-direction: column; gap: 0.6em; }
    .item { display:flex; align-items:center; justify-content: space-between; padding: 0.7em 0.8em; background: rgba(255,255,255,.04); border: 0.06em solid rgba(255,255,255,.08); border-radius: 0.9em; }
    .item .meta { font-size: 0.9em; color: var(--muted); }

    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,.4); opacity:0; pointer-events:none; transition: opacity .25s; z-index: 140; }
    .overlay.show { opacity:1; pointer-events: auto; }

    .modal { position: fixed; inset: 0; background: var(--bg2); z-index: 160; display:none; flex-direction: column; }
    .modal.show { display:flex; }
    .modal header { display:flex; justify-content: space-between; align-items:center; padding: 0.8em 0.9em; border-bottom: 0.06em solid rgba(255,255,255,.08);} 
    .modal .content { overflow:auto; padding: 0.9em; display:flex; flex-direction: column; gap: 0.8em; }

    .badge { background: rgba(255,255,255,.08); border: 0.06em solid rgba(255,255,255,.12); padding: 0.2em 0.6em; border-radius: 999px; font-size: 0.9em; }

    /* TYPE MODE â€“ full-height stacked layout */
    .typePane { grid-row: 1 / span 2; height: 100%; display:flex; flex-direction:column; gap: 1.2em; padding: 1.2em; box-sizing: border-box; }
    .block { width: 100%; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .grow { flex: 1 1 0; min-height: 0; }
    .block .label { font-size: 0.95em; color: var(--muted); margin-bottom: 0.7em; font-weight: 700; letter-spacing: .03em; }
    .fullInput { width: 100%; max-width: 100%; box-sizing: border-box; font-size: clamp(1.2em, 6vw, 2em); text-align: center; padding: 0.9em 0.8em; border-radius: 1em; border: 0.06em solid rgba(255,255,255,.2); background: rgba(255,255,255,.06); color: var(--fg); }
    .toggle { width: 100%; padding: 1.1em 0.9em; border-radius: 1em; border: 0.06em solid rgba(255,255,255,.2); background: rgba(255,255,255,.08); color: var(--fg); font-size: clamp(1.2em,5.5vw,1.5em); font-weight: 900; text-align: center; }
    .segmented { width: 100%; display:flex; gap: 0.9em; }
    .segmented button { flex: 1; padding: 1.1em 0; font-size: clamp(1.2em,5.5vw,1.5em); border-radius: 0.9em; border: 0.06em solid rgba(255,255,255,.2); background: rgba(255,255,255,.06); color: var(--fg); font-weight: 900; }
    .segmented .active { outline: 0.18em solid var(--accent); }
    /* Keypad */
    .keypad { width: 100%; display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.8em; }
    .keypad button { display:flex; align-items:center; justify-content:center; padding: 1.1em 0; font-size: clamp(1.2em, 6vw, 1.6em); border-radius: 0.9em; border: 0.06em solid rgba(255,255,255,.2); background: rgba(255,255,255,.07); color: var(--fg); font-weight: 900; }
    .keypad button:active { transform: scale(0.98); }
    .keypad .action { background: rgba(255,255,255,.05); border-color: rgba(255,255,255,.25); }
    .buttonStack { display:flex; flex-direction:column; gap: 1em; margin-top: auto; }
    .buttonStack .btnPrimary, .buttonStack .btnGhost { width: 100%; padding: 1.1em 0.9em; font-size: clamp(1.2em,5.5vw,1.5em); border-radius: 0.9em; }
    .btnPrimary { background: var(--accent); color: #000; border: none; font-weight: 900; }
    .btnGhost { background: transparent; border: 0.06em solid rgba(255,255,255,.2); color: var(--fg); font-weight: 800; }

    /* Mode visibility */
    .tapOnly { display: block; }
    .typeOnly { display: none; }
    .app[data-mode="type"] .tapOnly { display: none; }
    .app[data-mode="type"] .typeOnly { display: block; }

    @media (min-width: 600px) { .main { padding: calc(5.7em + env(safe-area-inset-top)) 1.4em 1.4em; gap: 1em; } }
  </style>
</head>
<body>
  <div class="app" id="app" data-mode="tap">
    <div class="header">
      <button id="modeBtn" class="btn hold" aria-label="Toggle mode (hold 1s)">
        <span class="title">Tap Mode</span>
        <span class="hold-progress"></span>
      </button>
      <div></div>
      <button id="sidebarBtn" class="btn hold" aria-label="Open sidebar (hold 1s)">â˜°
        <span class="hold-progress"></span>
      </button>
    </div>

    <main class="main">
      <!-- TAP MODE UI -->
      <section id="inputPane" class="pane inputPane tapOnly" role="button" aria-label="Top input area">
        <div id="topStatus" class="topStatus">Address #1</div>
        <div class="spooky">ðŸŽƒ</div>
      </section>

      <section id="enterPane" class="pane enterPane tapOnly" role="button" aria-label="Bottom enter area">
        <div class="enterInner">
          <div id="dbgAddr" class="line">Address: ____</div>
          <div id="dbgOutside" class="line">Outside: â€”</div>
          <div id="dbgAmount" class="line">Amount: â€”</div>
          <div class="subtle">Tap bottom to enter â€¢ Hold 1s to reset</div>
        </div>
      </section>

      <!-- TYPE MODE UI -->
      <section id="typePane" class="pane typePane typeOnly" aria-label="Type mode form">
        <div class="block grow" style="margin-bottom: 0.8em;">
          <div class="label">Address</div>
          <input id="typeAddress" class="fullInput" type="tel" inputmode="numeric" pattern="[0-9]{4}" maxlength="4" placeholder="0000" />
        </div>
        <div class="block grow" style="margin-bottom: 2em;">
          <div class="keypad" id="dialer" aria-label="Address dialer">
            <button type="button" data-key="1">1</button>
            <button type="button" data-key="2">2</button>
            <button type="button" data-key="3">3</button>
            <button type="button" data-key="4">4</button>
            <button type="button" data-key="5">5</button>
            <button type="button" data-key="6">6</button>
            <button type="button" data-key="7">7</button>
            <button type="button" data-key="8">8</button>
            <button type="button" data-key="9">9</button>
            <button type="button" class="action" data-key="reset">Reset</button>
            <button type="button" data-key="0">0</button>
            <button type="button" class="action" data-key="back">âŒ«</button>
          </div>
        </div>
        <div class="block grow" style="margin-bottom: 1.2em;">
          <div class="label">Outside</div>
          <button id="typeOutside" class="toggle" type="button">True (Outside)</button>
        </div>
        <div class="block grow" style="margin-bottom: 1.5em;">
          <div class="label">Candy (0â€“3)</div>
          <div id="typeCandy" class="segmented" role="group" aria-label="Candy amount">
            <button class="chip" data-val="0" type="button">0</button>
            <button class="chip" data-val="1" type="button">1</button>
            <button class="chip" data-val="2" type="button">2</button>
            <button class="chip" data-val="3" type="button">3</button>
          </div>
        </div>
        <div class="buttonStack">
          <button id="typeSave" class="btnPrimary" type="button">Save and New</button>
          <button id="typeReset" class="btnGhost" type="button">Reset Entry</button>
        </div>
      </section>
    </main>
  </div>

  <div class="sidebar" id="sidebar">
    <div class="grab"></div>
    <header>
      <strong>Recent entries</strong>
      <button class="full" id="fullListBtn">Full List</button>
    </header>
    <div class="list" id="recentList"></div>
  </div>
  <div class="overlay" id="overlay"></div>

  <div class="modal" id="fullModal">
    <header>
      <strong>All entries</strong>
      <button class="btn" id="closeFull">âœ•</button>
    </header>
    <div class="content" id="fullList"></div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
  (function(){
    const app = document.getElementById('app');
    const inputPane = document.getElementById('inputPane');
    const topStatus = document.getElementById('topStatus');
    const enterPane = document.getElementById('enterPane');
    const dbgAddr = document.getElementById('dbgAddr');
    const dbgOutside = document.getElementById('dbgOutside');
    const dbgAmount = document.getElementById('dbgAmount');
    const sidebarBtn = document.getElementById('sidebarBtn');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const modeBtn = document.getElementById('modeBtn');
    const toast = document.getElementById('toast');
    const fullListBtn = document.getElementById('fullListBtn');
    const fullModal = document.getElementById('fullModal');
    const closeFull = document.getElementById('closeFull');
    const recentList = document.getElementById('recentList');
    const fullList = document.getElementById('fullList');

    // TYPE MODE elements
    const typeAddress = document.getElementById('typeAddress');
    const typeOutside = document.getElementById('typeOutside');
    const typeCandy = document.getElementById('typeCandy');
    const typeSave = document.getElementById('typeSave');
    const typeReset = document.getElementById('typeReset');

    const HOLD_MS = 1000; // 1 second holds

    const state = {
      mode: 'tap',
      fieldIndex: 0,
      tapCount: 0,
      entry: { address: [0,0,0,0], outside: true, amount:0 },
      entries: loadEntries()
    };

    const fields = [
      { key:'address0', display:'Address #1', type:'digit', idx:0, max:9 },
      { key:'address1', display:'Address #2', type:'digit', idx:1, max:9 },
      { key:'address2', display:'Address #3', type:'digit', idx:2, max:9 },
      { key:'address3', display:'Address #4', type:'digit', idx:3, max:9 },
      { key:'outside',  display:'Outside',    type:'bool' },
      { key:'amount',   display:'Amount (0â€“3)', type:'scale', max:3 },
    ];

    function saveEntries(){
      localStorage.setItem('treatmap_entries', JSON.stringify(state.entries));
    }
    function loadEntries(){
      try {
        const raw = localStorage.getItem('treatmap_entries');
        return raw ? JSON.parse(raw) : [];
      } catch(e){ return []; }
    }

    function vibrate(ms){ if(window.navigator && navigator.vibrate) navigator.vibrate(ms); }

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 1200);
    }

    function formatEntry(e){
      const addr = e.address.join('');
      const outside = e.outside ? 'Outside' : 'Knock';
      return { addr, outside, amountLabel: String(e.amount) };
    }

    function renderLists(){
      recentList.innerHTML = '';
      const reversed = [...state.entries].reverse();
      reversed.forEach((e)=>{
        const f = formatEntry(e);
        const div = document.createElement('div');
        div.className = 'item';
        const left = document.createElement('div');
        left.innerHTML = `<strong>${f.addr}</strong><div class="meta">${f.outside} â€¢ ${f.amountLabel}</div>`;
        const time = document.createElement('span');
        time.className = 'badge';
        time.textContent = new Date(e.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        div.appendChild(left);
        div.appendChild(time);
        recentList.appendChild(div);
      });

      fullList.innerHTML = '';
      state.entries.forEach((e)=>{
        const f = formatEntry(e);
        const row = document.createElement('div');
        row.className = 'item';
        row.innerHTML = `<div><strong>${f.addr}</strong><div class="meta">${f.outside} â€¢ ${f.amountLabel}</div></div><span class="badge">${new Date(e.ts).toLocaleString()}</span>`;
        fullList.appendChild(row);
      });
    }

    function resetInProgress(){
      state.fieldIndex = 0;
      state.tapCount = 0;
      state.entry = { address: [0,0,0,0], outside: true, amount: 0 };
      updateUI();
      fillTypeUIFromState();
    }

    function flash(el){
      el.classList.remove('flash');
      void el.offsetWidth; // restart animation
      el.classList.add('flash');
      setTimeout(()=> el.classList.remove('flash'), 220);
    }

    function updateUI(){
      const field = fields[state.fieldIndex];
      if(topStatus) topStatus.textContent = field.display;
      const preview = { ...state.entry, address: [...state.entry.address] };
      if(field.type === 'digit'){
        const v = (state.entry.address[field.idx] + state.tapCount) % 10;
        preview.address[field.idx] = v;
      } else if(field.type === 'bool'){
        const v = (state.tapCount % 2 === 0); // even -> True (Outside)
        preview.outside = v;
      } else if(field.type === 'scale'){
        const v = (state.entry.amount + state.tapCount) % 4; // 0..3
        preview.amount = v;
      }
      dbgAddr.textContent = `Address: ${preview.address.map(d=>d).join('')}`;
      dbgOutside.textContent = `Outside: ${preview.outside ? 'True (Outside)' : 'False (Knock)'}`;
      dbgAmount.textContent = `Amount: ${preview.amount}`;
    }

    function commitField(){
      const field = fields[state.fieldIndex];
      if(field.type === 'digit'){
        state.entry.address[field.idx] = (state.entry.address[field.idx] + state.tapCount) % 10;
      } else if(field.type === 'bool'){
        state.entry.outside = (state.tapCount % 2 === 0);
      } else if(field.type === 'scale'){
        state.entry.amount = (state.entry.amount + state.tapCount) % 4; // 0..3
      }
      state.tapCount = 0;

      if(state.fieldIndex < fields.length - 1){
        state.fieldIndex++;
        vibrate(10);
        updateUI();
      } else {
        const final = { ...state.entry, ts: Date.now() };
        state.entries.push(final);
        saveEntries();
        renderLists();
        showToast('Saved ðŸŽƒ');
        vibrate(20);
        resetInProgress();
      }
    }

    // Touch/click dedupe
    let lastTouchTime = 0;
    function setupTap(el, handler){
      el.addEventListener('touchend', (e)=>{
        if(e.cancelable) e.preventDefault();
        lastTouchTime = Date.now();
        handler(e);
      }, {passive:false});
      el.addEventListener('click', (e)=>{
        if(Date.now() - lastTouchTime < 500) return; // ignore ghost click
        handler(e);
      });
    }

    function handleTopTap(){
      const field = fields[state.fieldIndex];
      if(field.type === 'digit'){
        state.tapCount = (state.tapCount + 1) % 10;
      } else if(field.type === 'bool'){
        state.tapCount = (state.tapCount + 1) % 1000000; // parity only
      } else if(field.type === 'scale'){
        state.tapCount = (state.tapCount + 1) % 4; // 0..3
      }
      flash(inputPane);
      updateUI();
    }

    setupTap(inputPane, handleTopTap);

    // Prevent accidental commit after a long-press reset
    let skipNextEnterTap = false;

    setupTap(enterPane, (e)=>{
      if(skipNextEnterTap){ skipNextEnterTap = false; return; }
      if(e && e.cancelable) e.preventDefault();
      flash(enterPane);
      commitField();
    });

    // Long-press utility
    function addHoldBehavior(el, onHold, progressEl){
      let timer = null;
      function start(e){
        e.preventDefault();
        if(progressEl){
          progressEl.style.transform = 'scaleX(0)';
          progressEl.style.transition = 'none';
          requestAnimationFrame(()=> {
            progressEl.style.transition = `transform ${HOLD_MS}ms linear`;
            progressEl.style.transform = 'scaleX(1)';
          });
        }
        timer = setTimeout(()=>{
          timer = null;
          if(progressEl){
            progressEl.style.transition = 'none';
            progressEl.style.transform = 'scaleX(0)';
          }
          onHold();
        }, HOLD_MS);
      }
      function clear(){
        if(timer){
          clearTimeout(timer);
          timer = null;
          if(progressEl){
            progressEl.style.transition = 'none';
            progressEl.style.transform = 'scaleX(0)';
          }
        }
      }
      el.addEventListener('touchstart', start, {passive:false});
      el.addEventListener('mousedown', start);
      el.addEventListener('touchend', clear);
      el.addEventListener('touchcancel', clear);
      el.addEventListener('mouseup', clear);
      el.addEventListener('mouseleave', clear);
    }

    // Hold 1s to reset the in-progress entry
    addHoldBehavior(enterPane, ()=>{
      resetInProgress();
      showToast('Entry reset');
      vibrate(30);
      skipNextEnterTap = true; // don't commit on touchend after long press
    });

    // Mode toggle (hold 1s)
    function setMode(m){
      state.mode = m;
      app.setAttribute('data-mode', m);
      modeBtn.querySelector('.title').textContent = (m === 'tap') ? 'Tap Mode' : 'Type Mode';
      if(m === 'type') fillTypeUIFromState();
    }

    addHoldBehavior(modeBtn, ()=>{
      setMode(state.mode === 'tap' ? 'type' : 'tap');
    }, modeBtn.querySelector('.hold-progress'));

    // Sidebar open (hold 1s)
    addHoldBehavior(sidebarBtn, ()=>{ openSidebar(); }, sidebarBtn.querySelector('.hold-progress'));

    function openSidebar(){
      sidebar.classList.add('open');
      overlay.classList.add('show');
    }
    function closeSidebar(){
      sidebar.classList.remove('open');
      overlay.classList.remove('show');
    }
    overlay.addEventListener('click', closeSidebar);
    overlay.addEventListener('touchstart', closeSidebar, {passive:true});

    // Swipe to close sidebar
    let startX = null;
    sidebar.addEventListener('touchstart', (e)=>{ startX = e.touches[0].clientX; });
    sidebar.addEventListener('touchmove', (e)=>{
      if(startX == null) return;
      const x = e.touches[0].clientX;
      const delta = startX - x;
      if(delta > 40){ closeSidebar(); startX = null; }
    });
    sidebar.addEventListener('touchend', ()=> startX = null);

    // Edge swipe to open sidebar (for reliability)
    let edgeStartX = null;
    document.addEventListener('touchstart', (e)=>{
      const x = e.touches[0].clientX;
      if(window.innerWidth - x < 24){ edgeStartX = x; } else { edgeStartX = null; }
    }, {passive:true});
    document.addEventListener('touchmove', (e)=>{
      if(edgeStartX == null) return;
      const x = e.touches[0].clientX;
      if(edgeStartX - x > 30){ openSidebar(); edgeStartX = null; }
    }, {passive:true});
    document.addEventListener('touchend', ()=> edgeStartX = null, {passive:true});

    // Full list modal
    fullListBtn.addEventListener('click', ()=>{ fullModal.classList.add('show'); });
    closeFull.addEventListener('click', ()=>{ fullModal.classList.remove('show'); });

    // ===== TYPE MODE LOGIC =====
    function fillTypeUIFromState(){
      const s = state.entry.address.join('');
      // Show placeholder when address is all zeros so keypad can start from empty
      typeAddress.value = (s === '0000') ? '' : s;
      typeOutside.textContent = state.entry.outside ? 'True (Outside)' : 'False (Knock)';
      [...typeCandy.querySelectorAll('.chip')].forEach(b=>{
        b.classList.toggle('active', Number(b.dataset.val) === state.entry.amount);
      });
    }

    typeAddress.addEventListener('input', ()=>{
      applyAddressString(typeAddress.value);
    });

    typeOutside.addEventListener('click', ()=>{
      state.entry.outside = !state.entry.outside;
      typeOutside.textContent = state.entry.outside ? 'True (Outside)' : 'False (Knock)';
      updateUI();
    });

    typeCandy.addEventListener('click', (e)=>{
      const b = e.target.closest('.chip');
      if(!b) return;
      state.entry.amount = Number(b.dataset.val);
      fillTypeUIFromState();
      updateUI();
    });

    typeSave.addEventListener('click', ()=>{
      const addrStr = typeAddress.value;
      if(addrStr.length !== 4){ showToast('Enter 4 address digits'); return; }
      const final = { ...state.entry, ts: Date.now() };
      state.entries.push(final);
      saveEntries();
      renderLists();
      showToast('Saved ðŸŽƒ');
      vibrate(20);
      resetInProgress();
      fillTypeUIFromState();
    });

    typeReset.addEventListener('click', ()=>{
      resetInProgress();
      showToast('Entry reset');
      vibrate(30);
    });

    function applyAddressString(raw){
      const digits = String(raw).replace(/[^0-9]/g,'').slice(0,4);
      typeAddress.value = digits;
      const arr = [0,0,0,0];
      for(let i=0;i<digits.length;i++) arr[i] = Number(digits[i]);
      state.entry.address = arr;
      updateUI();
    }

    // Dialer keypad logic
    const dialer = document.getElementById('dialer');
    if (dialer) {
      dialer.addEventListener('click', (e) => {
        const b = e.target.closest('button');
        if (!b) return;
        const key = b.dataset.key;
        let val = String(typeAddress.value || '').replace(/[^0-9]/g, '').slice(0, 4);
        if (key === 'back') {
          val = val.slice(0, -1);
        } else if (key === 'reset') {
          val = '';
        } else if (/^[0-9]$/.test(key)) {
          if (val.length < 4) val += key;
        }
        applyAddressString(val);
        vibrate(7);
      });
    }

    // ===== DEV SELF-TESTS (console only) =====
    (function runSelfTests(){
      try {
        const results = [];
        // Test 1: applyAddressString basic
        applyAddressString('1390');
        results.push({name:'applyAddressString 1390', pass: JSON.stringify(state.entry.address) === JSON.stringify([1,3,9,0]), got: state.entry.address.slice()});
        // Test 2: backspace via logic
        let tmp = '1390'; tmp = tmp.slice(0,-1); applyAddressString(tmp);
        results.push({name:'backspace -> 139', pass: JSON.stringify(state.entry.address) === JSON.stringify([1,3,9,0].slice(0,3).concat([0])) , got: state.entry.address.slice()});
        // Test 3: reset via logic
        applyAddressString('');
        results.push({name:'reset to empty', pass: JSON.stringify(state.entry.address) === JSON.stringify([0,0,0,0]), got: state.entry.address.slice()});
        console.table(results);
      } catch(err){ console.error('Self-tests error:', err); }
    })();

    // Init
    renderLists();
    updateUI();
  })();
  </script>
</body>
</html>
